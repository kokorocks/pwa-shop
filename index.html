<!--link rel="manifest" href="/manifest.json">
 <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
  .then(() => console.log('Service Worker Registered'))
    .catch((err) => console.log('Service Worker Registration Failed', err));
    }
   </script-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic PWA</title>
    <meta name="theme-color" content="#000000">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
            background: #f4f4f4;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>Dynamic PWA</h1>
    <button id="installPWA" style="display:none;">Install PWA</button>

    <script>
        // Dynamic Manifest
        const manifestData = {
            name: "Dynamic PWA",
            short_name: "PWA",
            start_url: "/",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#000000",
            icons: [
                {
                    src: "data:image/png;base64," + btoa("custom_icon_data"), // Example Base64
                    sizes: "192x192",
                    type: "image/png"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: "application/json" });
        const manifestURL = URL.createObjectURL(manifestBlob);
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = manifestURL;
        document.head.appendChild(link);

        // Dynamic Service Worker
        const swCode = `
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open('dynamic-pwa-cache').then((cache) => {
                        return cache.addAll([
                            '/',
                            '/index.html'
                        ]);
                    })
                );
            });

            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request).then((response) => {
                        return response || fetch(event.request);
                    })
                );
            });
        `;

        const swBlob = new Blob([swCode], { type: "application/javascript" });
        const swURL = URL.createObjectURL(swBlob);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swURL)
                .then(() => console.log('Service Worker Registered'))
                .catch((error) => console.error('Service Worker Registration Failed:', error));
        }

        // PWA Install Button
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (event) => {
            event.preventDefault();
            deferredPrompt = event;
            document.getElementById('installPWA').style.display = 'block';
        });

        document.getElementById('installPWA').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA Installed');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // Dynamic Icon
        const canvas = document.createElement("canvas");
        canvas.width = 192;
        canvas.height = 192;
        const ctx = canvas.getContext("2d");

        ctx.fillStyle = "blue";
        ctx.fillRect(0, 0, 192, 192);
        ctx.fillStyle = "white";
        ctx.font = "bold 50px Arial";
        ctx.fillText("PWA", 30, 120);

        const iconURL = canvas.toDataURL("image/png");
        const iconLink = document.createElement("link");
        iconLink.rel = "icon";
        iconLink.href = iconURL;
        document.head.appendChild(iconLink);

        // Download the PWA HTML File
        function downloadFile() {
            const fileContent = document.documentElement.outerHTML;
            const blob = new Blob([fileContent], { type: "text/html" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "dynamic_pwa.html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Auto-Download PWA File from External Site
        function fetchAndSave(url) {
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    const blob = new Blob([data], { type: "text/html" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "external_pwa.html";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => console.error("Fetch Error:", error));
        }
    </script>

    <button onclick="downloadFile()">Download This PWA</button>
    <button onclick="fetchAndSave('https://example.com/pwa.html')">Fetch & Save External PWA</button>

</body>
</html>
